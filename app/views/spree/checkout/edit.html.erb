<% @body_id = 'checkout-page' %>

<%
content_for :head do
  agent = request.env['HTTP_USER_AGENT']
  if agent =~ /Safari/ && !(agent =~ /Chrome/)
%>
  <script>
    if (!!window.performance && window.performance.navigation.type === 2) {
      window.location.reload();
    }
    window.onpageshow = function(event) {
      if (event.persisted) {
        window.location.reload()
      }
    }
  </script>
<%
  end
end
%>





<div class="col-md-12 m-0 p-0 text-center" style="height:250px; margin-top: 3em !important; background-image: url(<%= image_url('checkout-banner.png')%>); background-size: cover; background-position: center;" >
      <h1 class="pt-4 text-uppercase" style="padding-top:90px !important"><%= Spree.t('checkout_page.header') %></h1>
</div>

<div id="checkout" class="container checkout" data-hook>
  <%= render partial: 'spree/shared/error_messages', locals: { target: @order } %>

  <div class="row align-items-center mt-3 flex-column checkout-header" data-hook="checkout_header">

    
    <div class="checkout-progress" data-hook="checkout_progress" role="navigation" aria-label="<%= Spree.t('checkout_page.checkout_navigation') %>">
      <div class="container d-flex justify-content-between ">
        <div class="d-flex justify-content-between align-items-center"> 
          <div class="checkout-step active">
            <%= image_tag "icons/addresse.png", class: "checkout-icon" %>
          </div> 
          <span class="checkout-text ml-10"> <%= link_to "Informations client", spree.checkout_state_path('address') %> </span>
          <span class="checkout-line ml-10"></span>
        </div>
        <div class="d-flex justify-content-around align-items-center"> 
          <div class="checkout-step mr-10 <%= 'active' if (@order.state == 'delivery' || 'payment') %>">
            <%= image_tag "icons/delivery.png", class: "checkout-icon" %>
          </div> 
          <span class="checkout-text ml-10"><%= link_to "Modalité de livraison", spree.checkout_state_path('delivery') %></span>
          <span class="checkout-line ml-10"></span>
        </div>
        <div class="d-flex justify-content-between align-items-center"> 
          <div class="checkout-step mr-10 <%= 'active' if @order.state == 'payment' %>">
            <%= image_tag "icons/payment.png", class: "checkout-icon" %>
          </div> 
          <span class="checkout-text ml-10"><%= link_to "Modalité de paiement", spree.checkout_state_path('payment') %></span>
          <span class="checkout-line ml-10"></span>
        </div>
        <div class="d-flex justify-content-between align-items-center"> 
          <div class="checkout-step mr-10 <% 'active' if @order.state == 'confirm' %>">
             <%= image_tag "icons/confirmation.png", class: "checkout-icon" %>
          </div> 
          <span class="checkout-text ml-10">Confirmer la commande</span>
        </div>

      </div>
    </div>
  </div>

  <div class="row checkout-content" data-hook="checkout_content">
    <%= form_for @order, url: spree.update_checkout_path(@order.state), html: { id: "checkout_form_#{@order.state}", class: "w-100 d-lg-flex   flex-wrap position-relative" } do |form| %>
      <div class="<%= if @order.state != 'confirm' then 'col-lg-7' else 'col-md-12' end %>" data-hook="checkout_form_wrapper">
        <%= form.hidden_field :state_lock_version %>
        <%= render @order.state, form: form %>
      </div>

      <% unless @order.confirm? %>
        <div id="checkout-summary" class="col-md-3 col-lg-5 w-100" data-hook="checkout_summary_box">
          <div class="checkout-summary-container position-sticky" style="padding-top: 0em !important" >
            <%= render partial: 'summary', locals: { order: @order } %>
           
            <div class="row  d-flex justify-content-between pl-0 pr-0 w-100 col-md-12 mr-0" style="margin:0px !important">
              <div class="col-md-6 mb-4" style="padding: 0px 5px 0px 0px !important">
                <a href="#" class="btn btn-primary btnPrecedent btn-block spree-btn" > Précédent </a>
              </div>
              <div data-hook="buttons" class="col-md-6 mb-4" style="padding: 0px 0px 0px 5px !important">
                <% submit_label_key = @order.confirm? ? :place_order : :save_and_continue %>
                <%= submit_tag Spree.t(submit_label_key), class: 'btn btn-primary btnSuivant  float-right btn-block spree-btn text-uppercase font-weight-bold  ' %>
              </div>
            </div>

          </div>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

<script>
  window.addEventListener('DOMContentLoaded', function() {
    Spree.current_order_id = "<%= @order.number %>"
    Spree.current_order_token = "<%= @order.token %>"
  })
</script>
